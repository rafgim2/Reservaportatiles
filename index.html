<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RESERVA DE PORT√ÅTILES</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
    }

    /* Barra superior (t√≠tulo + controles) fija */
    .top-bar {
      position: sticky;
      top: 0;
      z-index: 50;
      background: #f5f5f5;
    }

    header {
      background: #1f4e79;
      color: white;
      padding: 16px 24px 10px;
      text-align: center;
    }

    header h1 {
      margin: 0;
      font-size: 24px;
      letter-spacing: 1px;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      padding: 8px 24px 6px;
      background: #f5f5f5;
    }

    main {
      padding: 12px 16px 24px;
    }

    label {
      font-weight: 600;
    }

    select {
      padding: 4px 8px;
      font-size: 14px;
    }

    .legend {
      font-size: 12px;
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .legend-color {
      width: 16px;
      height: 16px;
      border-radius: 4px;
      border: 1px solid #aaa;
    }

    .legend-color.reserved {
      background: #e53935;
    }

    .legend-color.free {
      background: #ffffff;
    }

    .table-container {
      max-width: 100%;
      overflow: auto;
      border: 1px solid #ccc;
      background: white;
      border-radius: 4px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      min-width: 900px;
      font-size: 12px;
      table-layout: fixed;
    }

    thead {
      background: #e1e9f2;
    }

    thead th {
      position: sticky;
      top: 0;
      z-index: 10;
      background: #e1e9f2;
      border: 1px solid #ccc;
      padding: 4px 6px;
      text-align: center;
      white-space: normal;
      word-break: break-word;
    }

    th,
    td {
      border: 1px solid #ccc;
      padding: 4px 6px;
      text-align: center;
      white-space: normal;
      word-break: break-word;
      width: 7.14%;
    }

    /* Primera y segunda columna pegadas a la izquierda */
    tbody td:nth-child(1),
    tbody td:nth-child(2) {
      position: sticky;
      left: 0;
      background: #f7f7f7;
      z-index: 1;
    }

    thead th:nth-child(1),
    thead th:nth-child(2) {
      position: sticky;
      left: 0;
      z-index: 11;
    }

    tbody tr:nth-child(odd) td {
      background: #fafafa;
    }

    td.reservable {
      cursor: pointer;
      transition: background 0.15s ease, color 0.15s ease;
    }

    td.reservable:hover {
      box-shadow: inset 0 0 0 2px #1f4e79;
    }

    td.reserved {
      background: #e53935 !important;
      color: #ffffff;
      font-weight: 700;
    }

    .info {
      font-size: 11px;
      color: #555;
      margin-top: 6px;
    }
  </style>
</head>
<body>
  <!-- Barra superior fija -->
  <div class="top-bar">
    <header>
      <h1>RESERVA DE PORT√ÅTILES</h1>
    </header>

    <div class="controls">
      <div>
        <label for="monthSelect">Mes:</label>
        <select id="monthSelect"></select>
      </div>
      <div class="legend">
        <span class="legend-item">
          <span class="legend-color free"></span> Libre
        </span>
        <span class="legend-item">
          <span class="legend-color reserved"></span> Reservado
        </span>
        <span>Haz doble clic o doble toque para reservar / liberar.</span>
      </div>
    </div>
  </div>

  <main>
    <div class="table-container">
      <table id="calendarTable">
        <!-- Cabecera y cuerpo se generan por JS -->
      </table>
    </div>

    <p class="info">
      * Las reservas pueden cambiarse o cancelarse durante un m√°ximo de 2 minutos desde el momento en que se realizan.
    </p>
  </main>

  <!-- JS con Firestore -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore,
      doc,
      onSnapshot,
      setDoc,
      deleteField
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // ‚è± TIEMPO M√ÅXIMO PARA DESHACER (ms) ‚Üí ahora 2 minutos
    const UNRESERVE_WINDOW_MS = 2 * 60 * 1000;

    const firebaseConfig = {
      apiKey: "AIzaSyD5EAMg-0p54f8bPq8SVdZ_ePg5Xso3cmg",
      authDomain: "arm1-acbba.firebaseapp.com",
      projectId: "arm1-acbba",
      storageBucket: "arm1-acbba.firebasestorage.app",
      messagingSenderId: "408825932019",
      appId: "1:408825932019:web:10f2079b590b4c9ca3af86",
      measurementId: "G-S78TM6PVRL"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    const months = [
      { year: 2025, month: 11, name: "Noviembre 2025" },
      { year: 2025, month: 12, name: "Diciembre 2025" },
      { year: 2026, month: 1, name: "Enero 2026" },
      { year: 2026, month: 2, name: "Febrero 2026" },
      { year: 2026, month: 3, name: "Marzo 2026" },
      { year: 2026, month: 4, name: "Abril 2026" },
      { year: 2026, month: 5, name: "Mayo 2026" },
      { year: 2026, month: 6, name: "Junio 2026" }
    ];

    const classes = [
      "Infantil 3 a√±os",
      "Infantil 4 a√±os",
      "Infantil 5 a√±os",
      "1¬∫",
      "2¬∫",
      "3¬∫",
      "4¬∫A",
      "4¬∫B",
      "5¬∫A",
      "5¬∫B",
      "6¬∫A",
      "6¬∫B"
    ];

    // Horarios normales (nov‚Äìmay)
    const defaultSlots = [
      "9:00-9:45",
      "9:45-10:30",
      "10:30-11:15",
      "11:45-12:30",
      "12:30-13:15",
      "13:15-14:00"
    ];

    // Horarios especiales para JUNIO 2026
    const juneSlots = [
      "9:00-9:40",
      "9:40-10:20",
      "10:20-11:00",
      "11:30-12:15",
      "12:15-13:00"
    ];

    function getSlotsForMonth(monthIndex) {
      const { year, month } = months[monthIndex];
      if (year === 2026 && month === 6) {
        return juneSlots;
      }
      return defaultSlots;
    }

    const monthSelect    = document.getElementById("monthSelect");
    const calendarTable  = document.getElementById("calendarTable");

    let currentMonthIndex = 0;
    let currentData = {};
    let unsubscribe = null;

    function monthDocRef(monthIndex) {
      const { year, month } = months[monthIndex];
      const id = `${year}-${String(month).padStart(2, "0")}`;
      return doc(db, "reservas_portatiles_celdas", id);
    }

    function buildReservationId(dateIso, slot, className) {
      return `${dateIso}__${slot}__${className}`;
    }

    function subscribeToMonth(monthIndex) {
      if (unsubscribe) {
        unsubscribe();
        unsubscribe = null;
      }
      currentMonthIndex = monthIndex;

      const ref = monthDocRef(monthIndex);
      unsubscribe = onSnapshot(ref, (snap) => {
        currentData = snap.exists() ? snap.data() : {};
        renderMonth(monthIndex);
      });
    }

    async function setReservationValue(id, value) {
      const ref = monthDocRef(currentMonthIndex);
      const update = {};
      update[id] = value;
      await setDoc(ref, update, { merge: true });
    }

    async function clearReservation(id) {
      const ref = monthDocRef(currentMonthIndex);
      const update = {};
      update[id] = deleteField();
      await setDoc(ref, update, { merge: true });
    }

    // Devuelve la reserva (si existe) para una fecha + franja, sin importar la clase
    function getExistingReservationForSlot(dateIso, slot) {
      const prefix = `${dateIso}__${slot}__`;

      for (const key in currentData) {
        const value = currentData[key];
        if (!value) continue; // sin reserva

        if (typeof value === "number" || value === true) {
          if (key.startsWith(prefix)) {
            const parts = key.split("__");
            const cls   = parts[2] || "";
            return {
              id: key,
              className: cls,
              value
            };
          }
        }
      }
      return null;
    }

    // Selector de meses
    months.forEach((m, index) => {
      const opt = document.createElement("option");
      opt.value = index;
      opt.textContent = m.name;
      monthSelect.appendChild(opt);
    });

    monthSelect.addEventListener("change", () => {
      const idx = parseInt(monthSelect.value, 10);
      subscribeToMonth(idx);
    });

    // Obtener d√≠as lectivos
    function getWeekdays(year, month) {
      const days = [];
      const date = new Date(year, month - 1, 1);
      while (date.getMonth() === month - 1) {
        const day = date.getDay(); // 0=Dom, 1=Lun,...,6=Sab
        if (day >= 1 && day <= 5) {
          const d = String(date.getDate()).padStart(2, "0");
          const m = String(month).padStart(2, "0");
          const y = year;
          days.push({
            iso: `${y}-${m}-${d}`,
            label: `${d}/${m}/${y}`
          });
        }
        date.setDate(date.getDate() + 1);
      }
      return days;
    }

    function renderMonth(monthIndex) {
      const { year, month } = months[monthIndex];
      const days = getWeekdays(year, month);
      const slotsForMonth = getSlotsForMonth(monthIndex);
      const saved = currentData || {};

      calendarTable.innerHTML = "";

      // CABECERA (thead)
      const thead = document.createElement("thead");
      const headerRow = document.createElement("tr");
      const labels = ["Fecha", "Sesi√≥n", ...classes];
      labels.forEach(text => {
        const th = document.createElement("th");
        th.textContent = text;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      calendarTable.appendChild(thead);

      // CUERPO (tbody)
      const tbody = document.createElement("tbody");

      days.forEach(day => {
        slotsForMonth.forEach(slot => {
          const tr = document.createElement("tr");

          const tdFecha = document.createElement("td");
          tdFecha.textContent = day.label;
          tr.appendChild(tdFecha);

          const tdSlot = document.createElement("td");
          tdSlot.textContent = slot;
          tr.appendChild(tdSlot);

          classes.forEach(cls => {
            const td = document.createElement("td");
            td.classList.add("reservable");
            td.dataset.date = day.iso;
            td.dataset.slot = slot;
            td.dataset.class = cls;

            const id = buildReservationId(day.iso, slot, cls);
            if (saved[id]) {
              td.classList.add("reserved");
            }

            tr.appendChild(td);
          });

          tbody.appendChild(tr);
        });
      });

      calendarTable.appendChild(tbody);
    }

    // üß† L√ìGICA DE RESERVA / LIBERACI√ìN CON DOBLE CLIC / DOBLE TOQUE
    const DOUBLE_CLICK_MS = 400;
    let lastCellId = null;
    let lastClickTime = 0;

    async function activarCelda(cell) {
      const { date, slot, class: className } = cell.dataset;
      const id = buildReservationId(date, slot, className);

      const value = currentData[id];   // puede ser undefined, true o timestamp (number)
      const now   = Date.now();

      // Si no hay reserva en esta celda: comprobar antes si la franja ya est√° ocupada
      if (!value) {
        const existing = getExistingReservationForSlot(date, slot);

        if (existing) {
          const reservedClass = existing.className || "otra clase";
          alert(`No puedes reservar esta franja horaria porque ya est√° reservada por ${reservedClass}.`);
          return;
        }

        // La franja est√° libre ‚Üí crear reserva con timestamp (ms)
        await setReservationValue(id, now);
        return;
      }

      // Si es un n√∫mero, es un timestamp ‚Üí comprobamos ventana de tiempo para DESHACER
      if (typeof value === "number") {
        const elapsed = now - value;
        if (elapsed <= UNRESERVE_WINDOW_MS) {
          await clearReservation(id);
        } else {
          alert("Esta reserva ya no se puede modificar.");
        }
        return;
      }

      // Compatibilidad con reservas antiguas (valor true): se permite borrar siempre
      if (value === true) {
        await clearReservation(id);
        return;
      }
    }

    calendarTable.addEventListener("click", (event) => {
      const cell = event.target.closest("td.reservable");
      if (!cell) return;

      const uniqueId = `${cell.dataset.date}__${cell.dataset.slot}__${cell.dataset.class}`;
      const now = Date.now();

      if (lastCellId === uniqueId && (now - lastClickTime) <= DOUBLE_CLICK_MS) {
        // Doble clic / doble toque ‚Üí activar
        activarCelda(cell);
        lastCellId = null;
        lastClickTime = 0;
      } else {
        // Primer clic ‚Üí solo marcar el tiempo
        lastCellId = uniqueId;
        lastClickTime = now;
      }
    });

    // Inicializar
    monthSelect.value = "0";
    subscribeToMonth(0);
  </script>
</body>
</html>
