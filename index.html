<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RESERVA DE PORTÁTILES</title>
  <style>
    :root {
      --col-date-width: 110px;
      --col-session-width: 90px;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
    }

    .top-bar {
      position: sticky;
      top: 0;
      z-index: 50;
      background: #f5f5f5;
    }

    header {
      background: #1f4e79;
      color: white;
      padding: 16px 24px 10px;
      text-align: center;
    }

    header h1 {
      margin: 0;
      font-size: 24px;
      letter-spacing: 1px;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      padding: 8px 24px 6px;
      background: #f5f5f5;
    }

    /* Leyenda */
    .legend {
      font-size: 12px;
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .legend-color {
      width: 16px;
      height: 16px;
      border-radius: 4px;
      border: 1px solid #aaa;
    }

    .legend-color.free {
      background: #ffffff;
    }

    .legend-color.reserved {
      background: #e53935;
    }

    .table-container {
      max-width: 100%;
      overflow: auto;
      border: 1px solid #ccc;
      background: white;
      border-radius: 4px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      min-width: 900px;
      font-size: 12px;
      table-layout: fixed;
    }

    thead th {
      position: sticky;
      top: 0;
      background: #dde3ff;
      border: 1px solid #ccc;
      z-index: 10;
      padding: 4px 6px;
      text-align: center;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 4px 6px;
      text-align: center;
    }

    /* Separación gruesa entre días */
    tbody tr.new-day-separator td {
      border-top: 3px solid #999 !important;
    }

    /* Sin cebra: todo blanco */
    tbody td {
      background: #ffffff;
    }

    /* Fila con reserva → rojo clarito */
    tbody tr.row-has-reservation td {
      background: #ffebee;
    }

    /* Celda reservada → rojo fuerte */
    td.reserved {
      background: #e53935 !important;
      color: white;
      font-weight: bold;
    }

    /* Reservas fijas */
    td.fixed-reserved {
      background: #b71c1c !important;
      color: white;
      font-weight: bold;
      cursor: default;
    }

    /* Hover */
    td.reservable:hover {
      box-shadow: inset 0 0 0 2px #1f4e79;
      cursor: pointer;
    }

    /* Marca de agua */
    td.reservable::before {
      content: attr(data-class);
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 10px;
      color: rgba(0,0,0,0.25);
      pointer-events: none;
      width: 100%;
    }

    .info {
      font-size: 11px;
      color: #555;
      margin-top: 6px;
    }

  </style>
</head>

<body>
  <div class="top-bar">
    <header>
      <h1>RESERVA DE PORTÁTILES</h1>
    </header>

    <div class="controls">
      <div>
        <label for="monthSelect">Mes:</label>
        <select id="monthSelect"></select>
      </div>

      <div class="legend">
        <span class="legend-item">
          <span class="legend-color free"></span> Libre
        </span>
        <span class="legend-item">
          <span class="legend-color reserved"></span> Reservado
        </span>
        <span>Haz doble clic o doble toque para reservar / liberar.</span>
      </div>
    </div>
  </div>

  <main>
    <div class="table-container">
      <table id="calendarTable"></table>
    </div>

    <p class="info">
      * Las reservas pueden deshacerse durante los primeros 2 minutos.
    </p>
    <p class="info">
      * Solo una reserva por semana en las últimas 24 horas.
    </p>
  </main>

  <script type="module">
    /* --- IMPORT, FIRESTORE Y TODA LA LÓGICA ES LA MISMA --- */
    /* --- SOLO TE MODIFIQUÉ LA PARTE DEL RENDER --- */

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore, doc, onSnapshot, setDoc, deleteField
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const UNRESERVE_WINDOW_MS = 2 * 60 * 1000;
    const USER_RESERVATION_TTL_MS = 24 * 60 * 60 * 1000;

    const firebaseConfig = {
      apiKey: "AIzaSyD5EAMg-0p54f8bPq8SVdZ_ePg5Xso3cmg",
      authDomain: "arm1-acbba.firebaseapp.com",
      projectId: "arm1-acbba",
      storageBucket: "arm1-acbba.firebasestorage.app",
      messagingSenderId: "408825932019",
      appId: "1:408825932019:web:10f2079b590b4c9ca3af86",
      measurementId: "G-S78TM6PVRL"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    /* --- CONFIG, HORARIOS, ETC. (SIN CAMBIOS) --- */

    const months = [
      { year: 2025, month: 11, name: "Noviembre 2025"},
      { year: 2025, month: 12, name: "Diciembre 2025"},
      { year: 2026, month: 1, name: "Enero 2026"},
      { year: 2026, month: 2, name: "Febrero 2026"},
      { year: 2026, month: 3, name: "Marzo 2026"},
      { year: 2026, month: 4, name: "Abril 2026"},
      { year: 2026, month: 5, name: "Mayo 2026"},
      { year: 2026, month: 6, name: "Junio 2026"}
    ];

    const classesList = [
      "Infantil 3 años","Infantil 4 años","Infantil 5 años",
      "1ºA","2ºA","3ºA","4ºA","4ºB","5ºA","5ºB","6ºA","6ºB"
    ];

    const defaultSlots = [
      "9:00-9:45","9:45-10:30","10:30-11:15",
      "11:45-12:30","12:30-13:15","13:15-14:00"
    ];

    const juneSlots = [
      "9:00-9:40","9:40-10:20","10:20-11:00",
      "11:30-12:15","12:15-13:00"
    ];

    function getSlotsForMonth(i){
      const {year, month}=months[i];
      return (year===2026 && month===6)?juneSlots:defaultSlots;
    }

    const FIXED = [
      {weekday:5,session:1,className:"3ºA"},
      {weekday:4,session:4,className:"5ºA"},
      {weekday:5,session:4,className:"1ºA"},
      {weekday:4,session:5,className:"4ºA"},
      {weekday:3,session:6,className:"6ºB"},
      {weekday:4,session:6,className:"6ºA"},
      {weekday:5,session:6,className:"5ºB"}
    ];

    function isFixedReservation(dateIso, slot, className){
      const d=new Date(dateIso);
      const w=d.getDay(); if(w<1||w>5)return false;
      const slots=getSlotsForMonth(currentMonthIndex);
      const idx=slots.indexOf(slot); if(idx===-1)return false;
      const session=idx+1;
      return FIXED.some(x=>x.weekday===w && x.session===session && x.className===className);
    }

    function getFixedReservationForSlot(dateIso, slot){
      const d=new Date(dateIso);
      const w=d.getDay(); if(w<1||w>5)return null;
      const slots=getSlotsForMonth(currentMonthIndex);
      const idx=slots.indexOf(slot); if(idx===-1)return null;
      const session=idx+1;
      return FIXED.find(x=>x.weekday===w && x.session===session)||null;
    }

    /* --- DOM --- */
    const monthSelect = document.getElementById("monthSelect");
    const calendarTable = document.getElementById("calendarTable");

    months.forEach((m,i)=>{
      const opt=document.createElement("option");
      opt.value=i; opt.textContent=m.name;
      monthSelect.appendChild(opt);
    });

    monthSelect.addEventListener("change",()=>{
      subscribeToMonth(parseInt(monthSelect.value));
    });

    function monthDocRef(i){
      const {year,month}=months[i];
      return doc(db,"reservas_portatiles_celdas",`${year}-${String(month).padStart(2,"0")}`);
    }

    let currentMonthIndex=0;
    let currentData={};
    let unsubscribe=null;

    function subscribeToMonth(i){
      if(unsubscribe)unsubscribe();
      currentMonthIndex=i;
      unsubscribe=onSnapshot(monthDocRef(i),(snap)=>{
        currentData=snap.exists()?snap.data():{};
        renderMonth(i);
      });
    }

    function buildReservationId(dateIso,slot,cls){
      return `${dateIso}__${slot}__${cls}`;
    }

    /* --- NUEVA FUNCIÓN PARA OBTENER LOS DÍAS CON INICIAL --- */

    function getWeekdays(year, month){
      const days=[];
      const initials=["D","L","M","X","J","V","S"];

      const d=new Date(year,month-1,1);
      while(d.getMonth()==month-1){
        const w=d.getDay();
        if(w>=1 && w<=5){
          const dd=String(d.getDate()).padStart(2,"0");
          const mm=String(month).padStart(2,"0");
          const iso=`${year}-${mm}-${dd}`;
          const label=`${initials[w]} ${dd}/${mm}/${year}`;
          days.push({iso,label});
        }
        d.setDate(d.getDate()+1);
      }
      return days;
    }

    /* --- AQUÍ VA EL NUEVO RENDER COMPLETO --- */

    function renderMonth(i){
      const {year,month}=months[i];
      const days=getWeekdays(year,month);
      const slots=getSlotsForMonth(i);
      const saved=currentData;

      calendarTable.innerHTML="";

      /* CABECERA */
      const thead=document.createElement("thead");
      const trh=document.createElement("tr");
      ["Fecha","Sesión",...classesList].forEach(t=>{
        const th=document.createElement("th");
        th.textContent=t;
        trh.appendChild(th);
      });
      thead.appendChild(trh);
      calendarTable.appendChild(thead);

      /* CUERPO */
      const tbody=document.createElement("tbody");

      let isFirstSlot = true;

      days.forEach(day=>{
        isFirstSlot = true;

        slots.forEach(slot=>{
          const tr=document.createElement("tr");

          /* Línea gruesa solo al inicio del día */
          if(isFirstSlot){
            tr.classList.add("new-day-separator");
            isFirstSlot=false;
          }

          const tdFecha=document.createElement("td");
          tdFecha.textContent=day.label;
          tr.appendChild(tdFecha);

          const tdSlot=document.createElement("td");
          tdSlot.textContent=slot;
          tr.appendChild(tdSlot);

          let rowHasReservation=false;

          classesList.forEach(cls=>{
            const td=document.createElement("td");
            td.classList.add("reservable");
            td.dataset.date=day.iso;
            td.dataset.slot=slot;
            td.dataset.class=cls;

            const id=buildReservationId(day.iso,slot,cls);

            if(isFixedReservation(day.iso,slot,cls)){
              td.classList.add("fixed-reserved");
              td.dataset.fixed="true";
              rowHasReservation=true;
            } else if(saved[id]){
              td.classList.add("reserved");
              rowHasReservation=true;
            }

            tr.appendChild(td);
          });

          if(rowHasReservation){
            tr.classList.add("row-has-reservation");
          }

          tbody.appendChild(tr);
        });
      });

      calendarTable.appendChild(tbody);
    }

    /* --- DOBLE CLIC (igual que antes) --- */

    const DOUBLE_CLICK_MS = 400;
    let lastCellId=null;
    let lastClickTime=0;

    async function activarCelda(cell){
      if(cell.dataset.fixed==="true"){
        alert("Reserva fija del horario.");
        return;
      }

      const {date,slot,class:cls}=cell.dataset;
      const id=buildReservationId(date,slot,cls);
      const now=Date.now();
      const value=currentData[id];

      if(!value){
        const exists=getExistingReservation(date,slot);
        if(exists){
          alert("Esta franja ya está reservada.");
          return;
        }
        await setDoc(monthDocRef(currentMonthIndex),{[id]:now},{merge:true});
        return;
      }

      if(typeof value==="number" && now-value<=UNRESERVE_WINDOW_MS){
        await setDoc(monthDocRef(currentMonthIndex),{[id]:deleteField()},{merge:true});
      } else {
        alert("Ya no se puede modificar esta reserva.");
      }
    }

    function getExistingReservation(dateIso,slot){
      const prefix=`${dateIso}__${slot}__`;
      for(const k in currentData){
        if(k.startsWith(prefix)) return currentData[k];
      }
      return getFixedReservationForSlot(dateIso,slot);
    }

    calendarTable.addEventListener("click",(ev)=>{
      const cell=ev.target.closest("td.reservable");
      if(!cell)return;
      const uid=`${cell.dataset.date}__${cell.dataset.slot}__${cell.dataset.class}`;
      const now=Date.now();
      if(lastCellId===uid && (now-lastClickTime)<=DOUBLE_CLICK_MS){
        activarCelda(cell);
        lastCellId=null;
      } else {
        lastCellId=uid;
        lastClickTime=now;
      }
    });

    /* Iniciar */
    monthSelect.value="0";
    subscribeToMonth(0);

  </script>
</body>
</html>
