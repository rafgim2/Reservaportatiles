<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RESERVA DE PORTÁTILES</title>
  <style>
    :root {
      --col-date-width: 110px;
      --col-session-width: 90px;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
    }

    .top-bar {
      position: sticky;
      top: 0;
      z-index: 50;
      background: #f5f5f5;
    }

    header {
      background: #1f4e79;
      color: white;
      padding: 16px 24px 10px;
      text-align: center;
    }

    header h1 {
      margin: 0;
      font-size: 24px;
      letter-spacing: 1px;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      padding: 8px 24px 6px;
      background: #f5f5f5;
    }

    main {
      padding: 12px 16px 24px;
    }

    label {
      font-weight: 600;
    }

    select {
      padding: 4px 8px;
      font-size: 14px;
    }

    .legend {
      font-size: 12px;
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .legend-color {
      width: 16px;
      height: 16px;
      border-radius: 4px;
      border: 1px solid #aaa;
    }

    .legend-color.reserved { background: #e53935; }
    .legend-color.free { background: #ffffff; }

    .table-container {
      max-width: 100%;
      overflow: auto;
      border: 1px solid #ccc;
      background: white;
      border-radius: 4px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      min-width: 900px;
      font-size: 12px;
      table-layout: fixed;
    }

    /* CABECERA — TODA EN AZULITO */
    thead th {
      position: sticky;
      top: 0;
      z-index: 10;
      background: #dde3ff; /* <<< AQUÍ EL COLOR DE CABECERA */
      border: 1px solid #ccc;
      padding: 4px 6px;
      text-align: center;
    }

    /* Fecha y Sesión pegadas a la izquierda (solo en la cabecera) */
    thead th:nth-child(1) {
      position: sticky;
      left: 0;
      z-index: 11;
      background: #dde3ff; /* <<< SOLO cabecera */
    }

    thead th:nth-child(2) {
      position: sticky;
      left: var(--col-date-width);
      z-index: 11;
      background: #dde3ff; /* <<< SOLO cabecera */
    }

    th, td {
      border: 1px solid #ccc;
      padding: 4px 6px;
      text-align: center;
    }

    /* Cuerpo: fecha + sesión pegadas y SIN fondo extra */
    tbody td:nth-child(1) {
      position: sticky;
      left: 0;
      z-index: 11;
    }

    tbody td:nth-child(2) {
      position: sticky;
      left: var(--col-date-width);
      z-index: 11;
    }

    /* Colores por día (alternados) */
    tbody tr.day-a td { background: #ffffff; }
    tbody tr.day-b td { background: #dde3ff; }

    /* ESTO asegura que Fecha/Sesión del cuerpo también alternen por día */
    tbody tr.day-a td:nth-child(1),
    tbody tr.day-a td:nth-child(2) {
      background: #ffffff;
    }

    tbody tr.day-b td:nth-child(1),
    tbody tr.day-b td:nth-child(2) {
      background: #dde3ff;
    }

    td.reservable {
      cursor: pointer;
      position: relative;
      overflow: hidden;
      transition: background 0.15s ease;
    }

    td.reservable:hover {
      box-shadow: inset 0 0 0 2px #1f4e79;
    }

    td.reserved {
      background: #e53935 !important;
      color: white;
      font-weight: 700;
    }

    td.reservable::before {
      content: attr(data-class);
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 10px;
      color: rgba(0,0,0,0.25);
      pointer-events: none;
      width: 100%;
      text-align: center;
    }

    td.reserved::before { color: rgba(255,255,255,0.6); }

    .info {
      font-size: 11px;
      color: #555;
      margin-top: 6px;
    }
  </style>
</head>
<body>

  <div class="top-bar">
    <header><h1>RESERVA DE PORTÁTILES</h1></header>

    <div class="controls">
      <div>
        <label for="monthSelect">Mes:</label>
        <select id="monthSelect"></select>
      </div>
      <div class="legend">
        <span class="legend-item"><span class="legend-color free"></span>Libre</span>
        <span class="legend-item"><span class="legend-color reserved"></span>Reservado</span>
        <span>Haz doble clic o doble toque para reservar / liberar.</span>
      </div>
    </div>
  </div>

  <main>
    <div class="table-container">
      <table id="calendarTable"></table>
    </div>

    <p class="info">* Las reservas pueden cambiarse o cancelarse durante un máximo de 2 minutos desde el momento en que se realizan.</p>
    <p class="info">* Solo se puede realizar una reserva cada 24 horas.</p>
  </main>

  <!-- ==================== JS ==================== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, doc, onSnapshot, setDoc, deleteField }
      from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const UNRESERVE_WINDOW_MS = 2 * 60 * 1000;
    const USER_RESERVATION_TTL_MS = 24 * 60 * 60 * 1000;

    const firebaseConfig = {
      apiKey: "AIzaSyD5EAMg-0p54f8bPq8SVdZ_ePg5Xso3cmg",
      authDomain: "arm1-acbba.firebaseapp.com",
      projectId: "arm1-acbba",
      storageBucket: "arm1-acbba.firebasestorage.app",
      messagingSenderId: "408825932019",
      appId: "1:408825932019:web:10f2079b590b4c9ca3af86",
      measurementId: "G-S78TM6PVRL"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const months = [
      { year: 2025, month: 11, name: "Noviembre 2025" },
      { year: 2025, month: 12, name: "Diciembre 2025" },
      { year: 2026, month: 1, name: "Enero 2026" },
      { year: 2026, month: 2, name: "Febrero 2026" },
      { year: 2026, month: 3, name: "Marzo 2026" },
      { year: 2026, month: 4, name: "Abril 2026" },
      { year: 2026, month: 5, name: "Mayo 2026" },
      { year: 2026, month: 6, name: "Junio 2026" }
    ];

    const classes = [
      "Infantil 3 años", "Infantil 4 años", "Infantil 5 años",
      "1ºA","2ºA","3ºA",
      "4ºA","4ºB",
      "5ºA","5ºB",
      "6ºA","6ºB"
    ];

    const defaultSlots = [
      "9:00-9:45","9:45-10:30","10:30-11:15",
      "11:45-12:30","12:30-13:15","13:15-14:00"
    ];

    const juneSlots = [
      "9:00-9:40","9:40-10:20","10:20-11:00",
      "11:30-12:15","12:15-13:00"
    ];

    function getSlotsForMonth(i) {
      const m = months[i];
      return (m.year === 2026 && m.month === 6) ? juneSlots : defaultSlots;
    }

    const monthSelect = document.getElementById("monthSelect");
    const calendarTable = document.getElementById("calendarTable");

    let currentMonthIndex = 0;
    let currentData = {};
    let unsubscribe = null;

    months.forEach((m,i)=>{
      const o=document.createElement("option");
      o.value=i;o.textContent=m.name;
      monthSelect.appendChild(o);
    });

    monthSelect.value="0";

    monthSelect.addEventListener("change",()=>{
      subscribeToMonth(parseInt(monthSelect.value));
    });

    function monthDocRef(i){
      const {year,month}=months[i];
      return doc(db,"reservas_portatiles_celdas",`${year}-${String(month).padStart(2,"0")}`);
    }

    function subscribeToMonth(i){
      if(unsubscribe) unsubscribe();
      currentMonthIndex=i;
      unsubscribe = onSnapshot(monthDocRef(i),(snap)=>{
        currentData = snap.exists() ? snap.data() : {};
        renderMonth(i);
      });
    }

    function buildReservationId(date,slot,cls){
      return `${date}__${slot}__${cls}`;
    }

    async function setReservationValue(id,val){
      const ref = monthDocRef(currentMonthIndex);
      await setDoc(ref,{[id]:val},{merge:true});
    }

    async function clearReservation(id){
      const ref = monthDocRef(currentMonthIndex);
      await setDoc(ref,{[id]:deleteField()},{merge:true});
    }

    const LOCAL_KEY="reservas_movil";
    const getUserInfo=()=>{
      try{
        const raw=localStorage.getItem(LOCAL_KEY);
        if(!raw) return null;
        const obj=JSON.parse(raw);
        if(!obj) return null;
        if(Date.now()-obj.time > USER_RESERVATION_TTL_MS){
          localStorage.removeItem(LOCAL_KEY);
          return null;
        }
        return obj;
      }catch{ return null; }
    };
    const setUserInfo=(id,t)=>localStorage.setItem(LOCAL_KEY,JSON.stringify({id,time:t}));
    const clearUserInfo=()=>localStorage.removeItem(LOCAL_KEY);
    const docId=()=>`${months[currentMonthIndex].year}-${String(months[currentMonthIndex].month).padStart(2,"0")}`;
    const fullId=id=>`${docId()}::${id}`;

    function getExistingReservationForSlot(date,slot){
      const prefix = `${date}__${slot}__`;
      for(const key in currentData){
        if(key.startsWith(prefix) && currentData[key]){
          const cls=key.split("__")[2];
          return {id:key, className:cls};
        }
      }
      return null;
    }

    function getWeekdays(y,m){
      const arr=[];
      const d=new Date(y,m-1,1);
      while(d.getMonth()==m-1){
        const wd=d.getDay();
        if(wd>=1 && wd<=5){
          const dd=String(d.getDate()).padStart(2,"0");
          const mm=String(m).padStart(2,"0");
          arr.push({iso:`${y}-${mm}-${dd}`,label:`${dd}/${mm}/${y}`});
        }
        d.setDate(d.getDate()+1);
      }
      return arr;
    }

    function renderMonth(i){
      const {year,month}=months[i];
      const days=getWeekdays(year,month);
      const slots=getSlotsForMonth(i);
      const saved=currentData||{};

      calendarTable.innerHTML="";

      const thead=document.createElement("thead");
      const trH=document.createElement("tr");
      ["Fecha","Sesión",...classes].forEach(t=>{
        const th=document.createElement("th");
        th.textContent=t;
        trH.appendChild(th);
      });
      thead.appendChild(trH);
      calendarTable.appendChild(thead);

      const tbody=document.createElement("tbody");

      let alt=false;

      days.forEach(day=>{
        alt=!alt;
        const classDay = alt ? "day-a" : "day-b";

        slots.forEach(slot=>{
          const tr=document.createElement("tr");
          tr.classList.add(classDay);

          const tdF=document.createElement("td");
          tdF.textContent=day.label;
          tr.appendChild(tdF);

          const tdS=document.createElement("td");
          tdS.textContent=slot;
          tr.appendChild(tdS);

          classes.forEach(cls=>{
            const td=document.createElement("td");
            td.classList.add("reservable");
            td.dataset.date=day.iso;
            td.dataset.slot=slot;
            td.dataset.class=cls;

            const id=buildReservationId(day.iso,slot,cls);
            if(saved[id]) td.classList.add("reserved");

            tr.appendChild(td);
          });

          tbody.appendChild(tr);
        });
      });

      calendarTable.appendChild(tbody);
    }

    const DOUBLE_MS=400;
    let last=null,lastTime=0;

    async function activarCelda(cell){
      const {date,slot,class:cls}=cell.dataset;
      const id=buildReservationId(date,slot,cls);
      const fId=fullId(id);
      const now=Date.now();
      const val=currentData[id];

      if(!val){
        let info=getUserInfo();

        if(info){
          const [dId,resId]=info.id.split("::");
          if(dId===docId()){
            if(!currentData[resId]){
              clearUserInfo();
              info=null;
            }
          }
        }

        if(info){
          alert("Ya tienes una reserva activa en las últimas 24 horas.");
          return;
        }

        const existing=getExistingReservationForSlot(date,slot);
        if(existing){
          alert("Esta franja ya está reservada por "+existing.className);
          return;
        }

        await setReservationValue(id,now);
        setUserInfo(fId,now);
        return;
      }

      if(typeof val==="number"){
        if(now-val <= UNRESERVE_WINDOW_MS){
          await clearReservation(id);
          const info=getUserInfo();
          if(info && info.id===fId) clearUserInfo();
        } else {
          alert("Esta reserva ya no se puede modificar.");
        }
        return;
      }

      if(val===true){
        await clearReservation(id);
        const info=getUserInfo();
        if(info && info.id===fId) clearUserInfo();
        return;
      }
    }

    calendarTable.addEventListener("click",(e)=>{
      const cell=e.target.closest("td.reservable");
      if(!cell) return;
      const id=`${cell.dataset.date}__${cell.dataset.slot}__${cell.dataset.class}`;
      const now=Date.now();

      if(last===id && now-lastTime <= DOUBLE_MS){
        activarCelda(cell);
        last=null;lastTime=0;
      } else {
        last=id;lastTime=now;
      }
    });

    subscribeToMonth(0);
  </script>

</body>
</html>
